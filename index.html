<!-- Versi final: Aplikasi Ujian Online (Admin realtime optional via Firebase) -->
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aplikasi Ujian - SMAS Plus Darussalam</title>
<style>
:root{--primary:#16a34a;--primary-dark:#15803d;--bg:#f0fff4;--text:#0f172a;--white:#fff}
*{box-sizing:border-box;font-family:Segoe UI, Tahoma, sans-serif}
body{margin:0;min-height:100vh;background:var(--bg);color:var(--text);user-select:none}
.container{max-width:1100px;margin:30px auto;padding:20px}
.card{background:var(--white);border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.header{display:flex;gap:16px;align-items:center}
.logo{width:84px;height:84px;border-radius:50%;overflow:hidden;border:4px solid var(--white)}
.title{color:var(--primary);font-weight:700}
.row{display:flex;gap:20px;margin-top:12px}
.col{flex:1}
input,select,textarea{width:100%;padding:10px;border:2px solid #e6f2ea;border-radius:8px}
button{background:var(--primary);color:var(--white);border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
button.secondary{background:transparent;color:var(--primary);border:2px solid var(--primary)}
.small{font-size:0.9rem;color:#374151}
.hidden{display:none}
#pdf-viewer{width:100%;height:68vh;border:2px solid #e6f2ea;border-radius:8px;overflow:hidden;background:#fff;display:flex;align-items:center;justify-content:center}
#pdf-viewer iframe{width:100%;height:100%;border:none}
.timer-box{background:var(--primary);color:white;padding:8px 12px;border-radius:8px;font-weight:700}
.notice{background:#ecfccb;border:1px solid #bef264;padding:10px;border-radius:8px;margin-top:10px}
.list{max-height:320px;overflow:auto;border:1px solid #eef2e7;padding:8px;border-radius:8px}
.user-line{display:flex;justify-content:space-between;padding:8px;border-bottom:1px dashed #f0f3f0}
.user-line .meta{font-size:0.85rem;color:#374151}
.center{text-align:center}
/* disable selection and context menu */
body,html{ -webkit-user-select:none; -moz-user-select:none; -ms-user-select:none; user-select:none }
</style>
</head>
<body>
<div class="container">
  <div class="card header">
    <img class="logo" src="/mnt/data/images (2).png" alt="logo sekolah"/>
    <div>
      <div class="title">Asesmen Sumatif Akhir Semester Ganjil SMA Plus Darussalam Lawang</div>
      <div class="small">Selamat datang — Pastikan baca instruksi ujian sebelum memulai.</div>
    </div>
  </div>

  <div id="view-area">

    <!-- LOGIN SISWA -->
    <div id="view-login" class="card" style="margin-top:18px">
      <h3>Login Siswa</h3>
      <div class="row">
        <div class="col">
          <label>Nama Lengkap</label>
          <input id="student-name" placeholder="Masukkan nama lengkap" />
        </div>
        <div style="width:180px">
          <label>Kelas</label>
          <select id="student-class"><option value="">Pilih Kelas</option><option value="X">X</option><option value="XI">XI</option><option value="XII_IBB">XII IBB</option><option value="XII_IIS">XII IIS</option></select>
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:10px">
        <button onclick="studentLogin()">Mulai Ujian</button>
        <button class="secondary" onclick="showAdminLogin()">Login Panitia</button>
      </div>
      <div class="notice">Aturan singkat: Jangan membuka tab/window baru. Jika keluar lebih dari 2 kali, ujian akan otomatis diselesaikan dan lapor ke panitia.</div>
    </div>

    <!-- ADMIN LOGIN -->
    <div id="view-admin-login" class="card hidden" style="margin-top:18px">
      <h3>Login Panitia</h3>
      <div style="display:flex;gap:10px;align-items:center">
        <input id="admin-user" placeholder="Username" />
        <input id="admin-pass" placeholder="Password" type="password" />
      </div>
      <div style="margin-top:10px;display:flex;gap:10px">
        <button onclick="adminLogin()">Masuk</button>
        <button class="secondary" onclick="backToLogin()">Batal</button>
      </div>
      <div class="small" style="margin-top:8px">Catatan: Untuk pengawasan realtime aktifkan Firebase (opsional). Jika tidak, admin dapat memulai ujian secara lokal (hanya mempengaruhi sesi admin & siswa yang mem-poll).</div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="view-admin-panel" class="card hidden" style="margin-top:18px">
      <h3>Dashboard Panitia</h3>
      <div style="display:flex;gap:12px;align-items:center">
        <button id="btn-open" onclick="openPortal()">Buka Portal</button>
        <button id="btn-close" class="secondary" onclick="closePortal()">Tutup Portal</button>
        <button id="btn-start" style="background:#0ea5a0" onclick="startExamByAdmin()">Mulai Ujian (Admin)</button>
      </div>

      <div style="margin-top:12px;display:flex;gap:12px">
        <div style="flex:1">
          <label>Durasi Ujian (Menit)</label>
          <input id="admin-duration" type="number" value="90" />
        </div>
        <div style="width:220px">
          <label>Link PDF (contoh Google Drive preview)</label>
          <input id="admin-link" placeholder="https://drive.google.com/.../preview?pli=1" />
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px">
        <button onclick="saveAdminSettings()">Simpan & Terapkan</button>
        <button class="secondary" onclick="resetAll()">Reset Semua Status</button>
      </div>

      <h4 style="margin-top:14px">Monitoring Siswa</h4>
      <div class="list" id="student-list">Tidak ada data siswa (jika Firebase tidak aktif, data hanya tersimpan lokal setiap sesi)</div>

      <div style="margin-top:12px"><small>Ket: Jika ingin monitoring realtime antar device, hubungkan Firebase pada konfigurasi di script (lihat komentar kode).</small></div>
    </div>

    <!-- HALAMAN UJIAN -->
    <div id="view-exam" class="card hidden" style="margin-top:18px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong id="exam-student"></strong><div class="small" id="exam-class"></div></div>
        <div style="display:flex;gap:10px;align-items:center"><div class="timer-box" id="timer-display">00:00:00</div></div>
      </div>
      <div id="pdf-viewer" style="margin-top:12px"><!-- iframe atau pesan akan dimasukkan --></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:space-between;align-items:center">
        <div class="small">⚠️ Dilarang membuka tab/window baru. Klik kanan dan copy dinonaktifkan.</div>
        <div style="display:flex;gap:8px">
          <button onclick="finishExam(true)" class="secondary">Selesai (Kirim)</button>
        </div>
      </div>
    </div>

    <!-- HALAMAN TERSELESAI -->
    <div id="view-finished" class="card hidden center" style="margin-top:18px">
      <h2>Ujian Selesai</h2>
      <div style="font-size:3rem; margin:12px 0">✅</div>
      <p id="finished-text">Terimakasih telah menyelesaikan ujian ini. Semoga diberikan hasil yang terbaik</p>
      <button onclick="location.reload()">Kembali</button>
    </div>

  </div>
</div>

<script>
// ------------------------
// CONFIG
// ------------------------
const ADMIN_USER = 'admin';
const ADMIN_PASS = 'smadalawang20517826';
// If you want realtime monitoring across devices, paste your Firebase config here
const FIREBASE_CONFIG = null; // <-- replace null with your firebase config object to enable realtime monitoring

// ------------------------
// State & util
// ------------------------
let examTimer = null;
let remaining = 0;
const MAX_CHEAT = 2; // jika melanggar >2 akan otomatis selesai

function hideAllViews(){ document.querySelectorAll('#view-area > .card').forEach(c=>c.classList.add('hidden')) }
function backToLogin(){ hideAllViews(); document.getElementById('view-login').classList.remove('hidden') }
function showAdminLogin(){ hideAllViews(); document.getElementById('view-admin-login').classList.remove('hidden') }

// ------------------------
// Admin: open/close portal, start exam, save settings
// ------------------------
function openPortal(){ localStorage.setItem('portalOpen','1'); alert('Portal dibuka'); updateStudentList(); }
function closePortal(){ localStorage.removeItem('portalOpen'); alert('Portal ditutup'); updateStudentList(); }

function saveAdminSettings(){
  const link = document.getElementById('admin-link').value.trim();
  const dur = parseInt(document.getElementById('admin-duration').value)||90;
  localStorage.setItem('examLink', link);
  localStorage.setItem('examDuration', dur);
  alert('Pengaturan disimpan');
}

function startExamByAdmin(){
  const dur = parseInt(localStorage.getItem('examDuration')||90);
  const startTime = Date.now();
  localStorage.setItem('examStartedAt', startTime);
  localStorage.setItem('examDuration', dur);
  // flag untuk siswa agar bisa mulai
  localStorage.setItem('examActive','1');
  alert('Ujian dimulai oleh admin — semua siswa yang masuk dapat memulai.');
}

function resetAll(){
  if(confirm('Reset semua data lokal? (Hanya untuk sesi ini)')){
    // bukan hapus file, hanya status
    localStorage.removeItem('examStartedAt');
    localStorage.removeItem('examActive');
    localStorage.removeItem('studentStatusList');
    alert('Status direset'); updateStudentList();
  }
}

function adminLogin(){
  const u = document.getElementById('admin-user').value;
  const p = document.getElementById('admin-pass').value;
  if(u===ADMIN_USER && p===ADMIN_PASS){ hideAllViews(); document.getElementById('view-admin-panel').classList.remove('hidden'); updateStudentList(); loadAdminInputs(); }
  else alert('Username / password salah');
}

function loadAdminInputs(){ document.getElementById('admin-link').value = localStorage.getItem('examLink')||''; document.getElementById('admin-duration').value = localStorage.getItem('examDuration')||90 }

// ------------------------
// Student login & session
// ------------------------
function studentLogin(){
  const name = document.getElementById('student-name').value.trim();
  const kelas = document.getElementById('student-class').value;
  if(!name||!kelas){ alert('Lengkapi nama dan kelas'); return }

  // check portal open
  if(!localStorage.getItem('portalOpen')){ alert('Portal ujian belum dibuka oleh panitia. Harap menunggu.'); return }

  // save session
  sessionStorage.setItem('stu_name',name);
  sessionStorage.setItem('stu_class',kelas);
  sessionStorage.setItem('cheatCount','0');
  sessionStorage.setItem('stu_status','entered');

  // register student to list (local mode)
  registerStudentLocal(name,kelas);

  startStudentExamUI();
}

function registerStudentLocal(name,kelas){
  let list = JSON.parse(localStorage.getItem('studentStatusList')||'[]');
  const id = name+'|'+kelas+'|'+Date.now();
  list = list.filter(i=>!i.startsWith(name+'|'+kelas+'|')); // replace existing for same name+kelas
  list.push(id+'::entered');
  localStorage.setItem('studentStatusList',JSON.stringify(list));
  updateStudentList();
}

function updateStudentList(){
  const el = document.getElementById('student-list');
  const arr = JSON.parse(localStorage.getItem('studentStatusList')||'[]');
  if(arr.length===0){ el.innerHTML='Belum ada siswa terdaftar'; return }
  const lines = arr.map(s=>{
    const [id,status]=s.split('::');
    const parts = id.split('|');
    return `<div class="user-line"><div><strong>${parts[0]}</strong><div class="meta">${parts[1]}</div></div><div><span class="meta">${status}</span></div></div>`
  }).join('');
  el.innerHTML = lines;
}

// ------------------------
// Exam UI for student
// ------------------------
function startStudentExamUI(){
  hideAllViews(); document.getElementById('view-exam').classList.remove('hidden');
  const name = sessionStorage.getItem('stu_name');
  const kelas = sessionStorage.getItem('stu_class');
  document.getElementById('exam-student').innerText = name;
  document.getElementById('exam-class').innerText = kelas;

  const link = localStorage.getItem('examLink');
  if(!link){ alert('Soal belum diinput admin'); backToLogin(); return }

  // set timer based on admin's start time if exists, else local start
  const dur = parseInt(localStorage.getItem('examDuration')||90);
  const startedAt = parseInt(localStorage.getItem('examStartedAt')||Date.now());
  const elapsed = Math.floor((Date.now() - startedAt)/1000);
  remaining = dur*60 - elapsed;
  if(remaining<=0){ alert('Waktu ujian sudah berakhir'); finishExam(true); return }

  startTimer();

  // show PDF in iframe (Drive preview recommended)
  document.getElementById('pdf-viewer').innerHTML = `<iframe src="${link}"></iframe>`;

  // enable anti-cheat listeners
  activateSecurityListeners();
}

function startTimer(){
  updateTimerDisplay();
  examTimer = setInterval(()=>{ remaining--; if(remaining<=0){ clearInterval(examTimer); finishExam(true) } updateTimerDisplay() },1000)
}
function updateTimerDisplay(){
  const h=Math.floor(remaining/3600); const m=Math.floor((remaining%3600)/60); const s=remaining%60;
  document.getElementById('timer-display').innerText = `${pad(h)}:${pad(m)}:${pad(s)}`;
}
function pad(n){return n.toString().padStart(2,'0')}

// ------------------------
// Anti-cheating
// ------------------------
function activateSecurityListeners(){
  // disable right click/context
  document.addEventListener('contextmenu',e=>e.preventDefault());
  // disable copy
  document.addEventListener('copy',e=>e.preventDefault());
  // disable common devtools keys
  document.onkeydown = function(e){
    if(e.keyCode==123) return false; // F12
    if(e.ctrlKey && e.shiftKey && (e.keyCode==73 || e.keyCode==74)) return false; // Ctrl+Shift+I/J
    if(e.ctrlKey && e.keyCode==85) return false; // Ctrl+U
  }
  // detect leaving tab/window
  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden) handleCheatEvent('tab-hidden')
  })
  window.addEventListener('blur', ()=>{ handleCheatEvent('blur') })
}

function handleCheatEvent(type){
  let count = parseInt(sessionStorage.getItem('cheatCount')||'0');
  count++;
  sessionStorage.setItem('cheatCount',count);
  // update local studentStatusList
  markStudentStatus(sessionStorage.getItem('stu_name'),sessionStorage.getItem('stu_class'), count>MAX_CHEAT? 'cheated' : `warning(${count})`);
  if(count>MAX_CHEAT){
    alert('Anda terdeteksi melanggar aturan. Ujian akan otomatis diselesaikan. Hubungi panitia.');
    finishExam(true,true);
  } else {
    alert(`PERINGATAN! Jangan tinggalkan halaman ujian. (${count}/${MAX_CHEAT})`)
  }
}

function markStudentStatus(name,kelas,status){
  let arr = JSON.parse(localStorage.getItem('studentStatusList')||'[]');
  // find and update
  arr = arr.map(s=>{
    const [id,st]=s.split('::');
    if(id.startsWith(name+'|'+kelas+'|')) return id+'::'+status; else return s;
  });
  localStorage.setItem('studentStatusList',JSON.stringify(arr)); updateStudentList();
}

// ------------------------
// Finish exam
// ------------------------
function finishExam(force=false,cheated=false){
  clearInterval(examTimer);
  const name = sessionStorage.getItem('stu_name'); const kelas = sessionStorage.getItem('stu_class');
  // mark finished
  markStudentStatus(name,kelas, cheated? 'cheated' : 'finished');
  // show finished page
  hideAllViews(); document.getElementById('view-finished').classList.remove('hidden');
  sessionStorage.clear();
}

// ------------------------
// utilities
// ------------------------
function backToLogin(){ hideAllViews(); document.getElementById('view-login').classList.remove('hidden') }

// initialize
(function init(){ backToLogin(); updateStudentList(); })();

</script>
</body>
</html>
